## deleteFunctions.vm

## Variables
## $failOverEnabled

function deleteFile {

    lcg-del -a $1
    if [ $? != 0 ]
    then
        guid=$(lcg-lg $1)
        surls=$(lcg-lr $1)
        for surl in $surls
        do
            lcg-uf -v $guid $surl
        done
    fi
}

function delete {

    local URI=$1
    local TEST=$2

    startLog file_delete uri="${URI}"

    ## The pattern must NOT be put between quotation marks.
    if [[ ${URI} == girder:/* ]]
    then
        info "delete not supported for girder"
    elif [[ ${URI} == file://* ]]
    then
        local FILENAME=`echo $URI | sed 's%file://*%/%'`

        info "Removing local file ${FILENAME}..."
        \rm -f $FILENAME
    else
        ## Extract the path part from the uri.
        local LFN=`echo "${URI}" | sed -r 's%^\w+://[^/]*(/[^?]+)(\?.*)?$%\1%'`

        if [ "${TEST}" = true ]
        then
            LFN=${LFN}-uploadTest;
        fi

        info "Deleting file ${LFN}..."
        deleteFile lfn:${LFN}

        #if ( $failOverEnabled )
        if [ $? != 0 ]
        then
            lcg-del --nobdii --defaultsetype srmv2 ${DM_DEST}
        fi
        #end
    fi

    stopLog file_delete
}
